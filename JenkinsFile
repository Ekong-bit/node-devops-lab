pipeline {
  agent any

  // Set your values
  environment {
    AWS_REGION       = 'eu-west-2'
    EB_APP           = 'node-devops-lab-20250817'
    EB_ENV           = 'node-devops-lab-20250817-env'
    ECR_REPO         = 'node-devops-lab-20250817'
    EB_BUNDLE_BUCKET = 'your-unique-eb-bundles-123456'
  }

  // Ensure Jenkins provides Node and npm
  tools {
    nodejs 'NodeJS 20'    // Configure this name in Global Tool Configuration
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install & Test') {
      steps {
        dir('app') {
          sh '''
            node -v
            npm -v
            npm ci
            npm test
          '''
        }
      }
    }

    stage('Docker Build') {
      steps {
        script {
          def accountId = sh(script: "aws sts get-caller-identity --query Account --output text", returnStdout: true).trim()
          env.ECR_REPO_URI = "${accountId}.dkr.ecr.${env.AWS_REGION}.amazonaws.com
